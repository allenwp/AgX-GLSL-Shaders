(* Content-type: application/vnd.wolfram.mathematica *)

(*** Wolfram Notebook File ***)
(* http://www.wolfram.com/nb *)

(* CreatedBy='Wolfram 14.1' *)

(*CacheID: 234*)
(* Internal cache information:
NotebookFileLineBreakTest
NotebookFileLineBreakTest
NotebookDataPosition[       154,          7]
NotebookDataLength[     12872,        371]
NotebookOptionsPosition[     12483,        357]
NotebookOutlinePosition[     12912,        373]
CellTagsIndexPosition[     12869,        370]
WindowFrame->Normal*)

(* Beginning of Notebook Content *)
Notebook[{
Cell[BoxData[{
 RowBox[{
  RowBox[{"<<", "FunctionApproximations`"}], "\n"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"kNormLog2Min", "=", 
   RowBox[{"-", "10"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"kNormLog2Max", "=", 
   RowBox[{"Rationalize", "[", "6.5", "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"kMidGray", "=", 
   RowBox[{"Rationalize", "[", "0.18", "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"kLog2Min", "=", 
   RowBox[{"Log2", "[", 
    RowBox[{
     RowBox[{"(", 
      RowBox[{"2", "^", "kNormLog2Min"}], ")"}], "*", "kMidGray"}], "]"}]}], 
  ";"}], "\n", 
 RowBox[{
  RowBox[{"kLog2Max", "=", 
   RowBox[{"Log2", "[", 
    RowBox[{
     RowBox[{"(", 
      RowBox[{"2", "^", "kNormLog2Max"}], ")"}], "*", "kMidGray"}], "]"}]}], 
  ";"}], "\n", 
 RowBox[{
  RowBox[{"kLinearMin", "=", 
   RowBox[{
    RowBox[{"(", 
     RowBox[{"2", "^", "kNormLog2Min"}], ")"}], "*", "kMidGray"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"kLinearMax", "=", 
   RowBox[{
    RowBox[{"(", 
     RowBox[{"2", "^", "kNormLog2Max"}], ")"}], "*", "kMidGray"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"kPower", "=", 
   RowBox[{"Rationalize", "[", "1.5", "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"kSlope", "=", 
   RowBox[{"Rationalize", "[", "2.4", "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"kXPivot", "=", 
   RowBox[{"Abs", "[", 
    RowBox[{"kNormLog2Min", "/", 
     RowBox[{"(", 
      RowBox[{"kNormLog2Max", "-", "kNormLog2Min"}], ")"}]}], "]"}]}], 
  ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"kYPivot", "=", 
    RowBox[{"kMidGray", "^", 
     RowBox[{"(", 
      RowBox[{"Rationalize", "[", 
       RowBox[{"1.0", "/", "2.4"}], "]"}], ")"}]}]}], ";"}], "\n"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"equationScale", "[", 
     RowBox[{
     "transitionX_", ",", "transitionY_", ",", "power_", ",", "slope_"}], 
     "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"termA", ",", "termB"}], "}"}], ",", 
      RowBox[{
       RowBox[{"termA", "=", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{"slope", "*", 
           RowBox[{"(", 
            RowBox[{"Rationalize", "[", 
             RowBox[{"1", "-", "transitionX"}], "]"}], ")"}]}], ")"}], "^", 
         RowBox[{"(", 
          RowBox[{"Rationalize", "[", 
           RowBox[{
            RowBox[{"-", "1"}], "*", "power"}], "]"}], ")"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"termB", "=", 
        RowBox[{"SetPrecision", "[", 
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{"(", 
             RowBox[{
              RowBox[{"(", 
               RowBox[{"slope", "*", 
                RowBox[{"(", 
                 RowBox[{"Rationalize", "[", 
                  RowBox[{"1", "-", "transitionX"}], "]"}], ")"}]}], ")"}], "/", 
              RowBox[{"(", 
               RowBox[{"Rationalize", "[", 
                RowBox[{"1", "-", "transitionY"}], "]"}], ")"}]}], ")"}], "^", 
            RowBox[{"(", "power", ")"}]}], "-", "1"}], ",", "20"}], "]"}]}], ";",
        "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"(", 
         RowBox[{"termA", "*", "termB"}], ")"}], "^", 
        RowBox[{"(", 
         RowBox[{"Rationalize", "[", 
          RowBox[{
           RowBox[{"-", "1"}], "/", "power"}], "]"}], ")"}]}]}]}], "]"}]}], 
   ";"}], "\n"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"exponentialCurve", "[", 
    RowBox[{
    "x_", ",", "scaleInput_", ",", "xPivot_", ",", "yPivot_", ",", "power_", ",",
      "slope_"}], "]"}], ":=", 
   RowBox[{
    RowBox[{"(", 
     RowBox[{"scaleInput", "*", 
      RowBox[{"exponential", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"(", 
          RowBox[{"slope", "*", 
           RowBox[{"(", 
            RowBox[{"x", "-", "xPivot"}], ")"}]}], ")"}], "/", "scaleInput"}],
         ",", "power"}], "]"}]}], ")"}], "+", "yPivot"}]}], "\n"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"exponential", "[", 
    RowBox[{"x_", ",", "power_"}], "]"}], ":=", 
   RowBox[{"x", "/", 
    RowBox[{"(", 
     RowBox[{
      RowBox[{"(", 
       RowBox[{"1", "+", 
        RowBox[{"(", 
         RowBox[{"x", "^", "power"}], ")"}]}], ")"}], "^", 
      RowBox[{"(", 
       RowBox[{"1", "/", "power"}], ")"}]}], ")"}]}]}], "\n"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"calculateSigmoid", "[", 
     RowBox[{"x_", ",", "xPivot_", ",", "yPivot_"}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", "scaleValue", "}"}], ",", 
      RowBox[{
       RowBox[{"scaleValue", "=", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"x", "<", "xPivot"}], ",", 
          RowBox[{
           RowBox[{"-", "1"}], "*", 
           RowBox[{"equationScale", "[", 
            RowBox[{
             RowBox[{"1.0", "-", "xPivot"}], ",", 
             RowBox[{"1.0", "-", "yPivot"}], ",", "kPower", ",", "kSlope"}], 
            "]"}]}], ",", 
          RowBox[{"equationScale", "[", 
           RowBox[{"xPivot", ",", "yPivot", ",", "kPower", ",", "kSlope"}], 
           "]"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"exponentialCurve", "[", 
        RowBox[{
        "x", ",", "scaleValue", ",", "xPivot", ",", "yPivot", ",", "kPower", ",",
          "kSlope"}], "]"}]}]}], "]"}]}], ";"}], "\n"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"agxCurve", "[", "x_", "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", "normalizedX", "}"}], ",", 
      RowBox[{
       RowBox[{"normalizedX", "=", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           RowBox[{"Log2", "[", 
            RowBox[{"x", "/", "kMidGray"}], "]"}], "-", "kNormLog2Min"}], 
          ")"}], "/", 
         RowBox[{"(", 
          RowBox[{"kNormLog2Max", "-", "kNormLog2Min"}], ")"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"calculateSigmoid", "[", 
         RowBox[{"normalizedX", ",", "kXPivot", ",", "kYPivot"}], "]"}], "^", 
        "kSlope"}]}]}], "]"}]}], ";"}], "\n"}], "\[IndentingNewLine]", 
 RowBox[{"Print", "[", "\"\<AgX tonemapping curve:\>\"", "]"}], "\n", 
 RowBox[{
  RowBox[{"Plot", "[", 
   RowBox[{
    RowBox[{"agxCurve", "[", "x", "]"}], ",", 
    RowBox[{"{", 
     RowBox[{"x", ",", "kLinearMin", ",", "kLinearMax"}], "}"}], ",", 
    RowBox[{"ScalingFunctions", "->", 
     RowBox[{"{", 
      RowBox[{"\"\<Log2\>\"", ",", "None"}], "}"}]}]}], "]"}], "\n"}], "\[IndentingNewLine]", 
 RowBox[{"Print", 
  "[", "\"\<Part of Timothy Lottes' tonemapping equation for the toe:\>\"", 
  "]"}], "\n", 
 RowBox[{"Print", "[", "\"\<Generic soultion for c:\>\"", "]"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"tonemapToe", "[", 
    RowBox[{"x_", ",", "a_"}], "]"}], ":=", 
   RowBox[{
    RowBox[{"(", 
     RowBox[{"x", "^", "a"}], ")"}], "/", 
    RowBox[{"(", 
     RowBox[{
      RowBox[{"(", 
       RowBox[{"x", "^", "a"}], ")"}], "+", "c"}], ")"}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"Solve", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
      RowBox[{"tonemapToe", "[", 
       RowBox[{"midIn", ",", "a"}], "]"}], "==", "midOut"}], "}"}], ",", 
    RowBox[{"{", "c", "}"}]}], "]"}], "\n"}], "\[IndentingNewLine]", 
 RowBox[{"Print", "[", "\"\<Soultion for c with hardcoded mid grey:\>\"", 
  "]"}], "\n", 
 RowBox[{
  RowBox[{"Solve", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
      RowBox[{"tonemapToe", "[", 
       RowBox[{"kMidGray", ",", "a"}], "]"}], "==", "kMidGray"}], "}"}], ",", 
    RowBox[{"{", "c", "}"}]}], "]"}], "\n"}], "\[IndentingNewLine]", 
 RowBox[{"Print", 
  "[", "\"\<NonlinearModelFit using solution for c from previous step. Range \
of toe only.\>\"", "]"}], "\n", 
 RowBox[{
  RowBox[{"dataToe", "=", 
   RowBox[{"Table", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"x", ",", 
       RowBox[{"agxCurve", "[", "x", "]"}]}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"x", ",", 
       RowBox[{"2", "^", 
        RowBox[{"Range", "[", 
         RowBox[{
          RowBox[{"Log2", "[", "kLinearMin", "]"}], ",", 
          RowBox[{"Log2", "[", "kMidGray", "]"}], ",", "0.001"}], "]"}]}]}], 
      "}"}]}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"nlmToe", "=", 
   RowBox[{"SetPrecision", "[", 
    RowBox[{
     RowBox[{"NonlinearModelFit", "[", 
      RowBox[{"dataToe", ",", 
       RowBox[{
        RowBox[{"(", 
         RowBox[{"x", "^", "a"}], ")"}], "/", 
        RowBox[{"(", 
         RowBox[{
          RowBox[{"(", 
           RowBox[{"x", "^", "a"}], ")"}], "+", 
          RowBox[{"(", 
           RowBox[{"41", " ", 
            SuperscriptBox["9", 
             RowBox[{
              RowBox[{"-", "1"}], "+", "a"}]], " ", 
            SuperscriptBox["50", 
             RowBox[{"-", "a"}]]}], ")"}]}], ")"}]}], ",", 
       RowBox[{"{", "a", "}"}], ",", "x"}], "]"}], ",", "15"}], "]"}]}], 
  ";"}], "\n", 
 RowBox[{"nlmfToeResult", "=", 
  RowBox[{"Normal", "[", "nlmToe", "]"}]}], "\n", 
 RowBox[{
  RowBox[{"Plot", "[", 
   RowBox[{"nlmfToeResult", ",", 
    RowBox[{"{", 
     RowBox[{"x", ",", "kLinearMin", ",", "kLinearMax"}], "}"}], ",", 
    RowBox[{"ScalingFunctions", "->", 
     RowBox[{"{", 
      RowBox[{"\"\<Log2\>\"", ",", "None"}], "}"}]}]}], "]"}], 
  "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
     RowBox[{"Print", "[", "\"\<Slope calculations:\>\"", "]"}], " ", 
     RowBox[{"nlmfResultPrime", "[", "x_", "]"}]}], "=", 
    RowBox[{
     RowBox[{"D", "[", 
      RowBox[{
       RowBox[{"nlm", "[", "x", "]"}], ",", "x"}], "]"}], " ", 
     RowBox[{"Print", "[", "\"\<Slope at mid grey:\>\"", "]"}], " ", 
     RowBox[{"nlmfResultPrime", "[", "kMidGray", "]"}]}]}], "*)"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{"Print", "[", "\"\<Target slope at 0.18:\>\"", "]"}], "\n", 
 RowBox[{
  RowBox[{"N", "[", 
   RowBox[{
    RowBox[{"D", "[", 
     RowBox[{
      RowBox[{"agxCurve", "[", "x", "]"}], ",", "x"}], "]"}], "/.", 
    RowBox[{"x", "->", "kMidGray"}]}], "]"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{"Print", "[", "\"\<Slope of flitted curve toe:\>\"", "]"}], "\n", 
 RowBox[{
  RowBox[{"nlmToePrime", "[", "x_", "]"}], "=", 
  RowBox[{"D", "[", 
   RowBox[{
    RowBox[{"nlmToe", "[", "x", "]"}], ",", "x"}], "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"nlmToePrime", "[", "kMidGray", "]"}], "\[IndentingNewLine]"}], "\n", 
 RowBox[{"Print", "[", "\"\<Various constants:\>\"", "]"}], "\n", 
 RowBox[{"Print", "[", "\"\<linear min:\>\"", "]"}], "\n", 
 RowBox[{"N", "[", 
  RowBox[{"kLinearMin", ",", "20"}], "]"}], "\n", 
 RowBox[{"Print", "[", "\"\<linear max:\>\"", "]"}], "\n", 
 RowBox[{"N", "[", 
  RowBox[{"kLinearMax", ",", "20"}], "]"}], "\n", 
 RowBox[{"Print", "[", "\"\<log2 min:\>\"", "]"}], "\n", 
 RowBox[{"N", "[", 
  RowBox[{"kLog2Min", ",", "20"}], "]"}], "\n", 
 RowBox[{"Print", "[", "\"\<log2 max:\>\"", "]"}], "\n", 
 RowBox[{
  RowBox[{"N", "[", 
   RowBox[{"kLog2Max", ",", "20"}], "]"}], "\n"}], "\[IndentingNewLine]", 
 RowBox[{"Print", "[", "\"\<agxCurve min:\>\"", "]"}], "\n", 
 RowBox[{"agxCurve", "[", "kLinearMin", "]"}], "\n", 
 RowBox[{"Print", "[", "\"\<agxCurve middle grey:\>\"", "]"}], "\n", 
 RowBox[{"N", "[", 
  RowBox[{"agxCurve", "[", "kMidGray", "]"}], "]"}], "\n", 
 RowBox[{"Print", "[", "\"\<agxCurve max:\>\"", "]"}], "\n", 
 RowBox[{"agxCurve", "[", "kLinearMax", "]"}]}], "Input",
 CellChangeTimes->CompressedData["
1:eJxTTMoPSmViYGAQBmIQnfLjeLRvyVtHGP3E0yETREvY82SD6Jyi910gOiKs
cjKI5hDuXgei1xzjXg+iFWaUbQPRK+50gekT3XOOgWlv4XMguuB1yjUQ7fDf
/yaIbmF5+AREX6jvfAE292PxGX8gLbLT7AKI5lnQdxNEp8z8dA9Ex8TsCAgA
0gdEn4eD6AfzItJAdMd59UwQHRFRUAKiXbLuVIDoKeH89SD6CKsjmK5JrGgH
0QKBCp0g2ocrphdE74gK7wPRPW+45oHohr5j88HyO9suguV3p94B0S27NR6A
6C2uZc9ANAAnrZoo
  "],
 CellLabel->"In[1]:=",ExpressionUUID->"fade57e0-a462-4144-8e6d-c41313c69901"]
},
WindowSize->{1150.8, 1216.8},
WindowMargins->{{317.4, Automatic}, {-4.7999999999999545`, Automatic}},
FrontEndVersion->"14.2 for Microsoft Windows (64-bit) (December 26, 2024)",
StyleDefinitions->"Default.nb",
ExpressionUUID->"1314a039-1bd9-d745-a688-c53e779c8ee4"
]
(* End of Notebook Content *)

(* Internal cache information *)
(*CellTagsOutline
CellTagsIndex->{}
*)
(*CellTagsIndex
CellTagsIndex->{}
*)
(*NotebookFileOutline
Notebook[{
Cell[554, 20, 11925, 335, 1400, "Input",ExpressionUUID->"fade57e0-a462-4144-8e6d-c41313c69901"]
}
]
*)

