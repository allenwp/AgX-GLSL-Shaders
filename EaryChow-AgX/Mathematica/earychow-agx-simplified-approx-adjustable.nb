(* Content-type: application/vnd.wolfram.mathematica *)

(*** Wolfram Notebook File ***)
(* http://www.wolfram.com/nb *)

(* CreatedBy='Wolfram 14.1' *)

(*CacheID: 234*)
(* Internal cache information:
NotebookFileLineBreakTest
NotebookFileLineBreakTest
NotebookDataPosition[       154,          7]
NotebookDataLength[     14828,        424]
NotebookOptionsPosition[     14439,        410]
NotebookOutlinePosition[     14868,        426]
CellTagsIndexPosition[     14825,        423]
WindowFrame->Normal*)

(* Beginning of Notebook Content *)
Notebook[{
Cell[BoxData[{
 RowBox[{
  RowBox[{"<<", "FunctionApproximations`"}], "\[IndentingNewLine]"}], "\n", 
 RowBox[{
  RowBox[{"kNormLog2Min", "=", 
   RowBox[{"-", "10"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"kNormLog2Max", "=", 
   RowBox[{"Rationalize", "[", "6.5", "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"kMidGray", "=", 
   RowBox[{"Rationalize", "[", "0.18", "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"kLog2Min", "=", 
   RowBox[{"Log2", "[", 
    RowBox[{
     RowBox[{"(", 
      RowBox[{"2", "^", "kNormLog2Min"}], ")"}], "*", "kMidGray"}], "]"}]}], 
  ";"}], "\n", 
 RowBox[{
  RowBox[{"kLog2Max", "=", 
   RowBox[{"Log2", "[", 
    RowBox[{
     RowBox[{"(", 
      RowBox[{"2", "^", "kNormLog2Max"}], ")"}], "*", "kMidGray"}], "]"}]}], 
  ";"}], "\n", 
 RowBox[{
  RowBox[{"kLinearMin", "=", 
   RowBox[{
    RowBox[{"(", 
     RowBox[{"2", "^", "kNormLog2Min"}], ")"}], "*", "kMidGray"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"kLinearMax", "=", 
   RowBox[{
    RowBox[{"(", 
     RowBox[{"2", "^", "kNormLog2Max"}], ")"}], "*", "kMidGray"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"kPower", "=", 
   RowBox[{"Rationalize", "[", "1.5", "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"kSlope", "=", 
   RowBox[{"Rationalize", "[", "2.4", "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"kXPivot", "=", 
   RowBox[{"Abs", "[", 
    RowBox[{"kNormLog2Min", "/", 
     RowBox[{"(", 
      RowBox[{"kNormLog2Max", "-", "kNormLog2Min"}], ")"}]}], "]"}]}], 
  ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"kYPivot", "=", 
    RowBox[{"kMidGray", "^", 
     RowBox[{"(", 
      RowBox[{"Rationalize", "[", 
       RowBox[{"1.0", "/", "2.4"}], "]"}], ")"}]}]}], ";"}], 
  "\[IndentingNewLine]"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"equationScale", "[", 
     RowBox[{
     "transitionX_", ",", "transitionY_", ",", "power_", ",", "slope_"}], 
     "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"termA", ",", "termB"}], "}"}], ",", 
      RowBox[{
       RowBox[{"termA", "=", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{"slope", "*", 
           RowBox[{"(", 
            RowBox[{"Rationalize", "[", 
             RowBox[{"1", "-", "transitionX"}], "]"}], ")"}]}], ")"}], "^", 
         RowBox[{"(", 
          RowBox[{"Rationalize", "[", 
           RowBox[{
            RowBox[{"-", "1"}], "*", "power"}], "]"}], ")"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"termB", "=", 
        RowBox[{"SetPrecision", "[", 
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{"(", 
             RowBox[{
              RowBox[{"(", 
               RowBox[{"slope", "*", 
                RowBox[{"(", 
                 RowBox[{"Rationalize", "[", 
                  RowBox[{"1", "-", "transitionX"}], "]"}], ")"}]}], ")"}], "/", 
              RowBox[{"(", 
               RowBox[{"Rationalize", "[", 
                RowBox[{"1", "-", "transitionY"}], "]"}], ")"}]}], ")"}], "^", 
            RowBox[{"(", "power", ")"}]}], "-", "1"}], ",", "20"}], "]"}]}], ";",
        "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"(", 
         RowBox[{"termA", "*", "termB"}], ")"}], "^", 
        RowBox[{"(", 
         RowBox[{"Rationalize", "[", 
          RowBox[{
           RowBox[{"-", "1"}], "/", "power"}], "]"}], ")"}]}]}]}], "]"}]}], 
   ";"}], "\[IndentingNewLine]"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"exponentialCurve", "[", 
    RowBox[{
    "x_", ",", "scaleInput_", ",", "xPivot_", ",", "yPivot_", ",", "power_", ",",
      "slope_"}], "]"}], ":=", 
   RowBox[{
    RowBox[{"(", 
     RowBox[{"scaleInput", "*", 
      RowBox[{"exponential", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"(", 
          RowBox[{"slope", "*", 
           RowBox[{"(", 
            RowBox[{"x", "-", "xPivot"}], ")"}]}], ")"}], "/", "scaleInput"}],
         ",", "power"}], "]"}]}], ")"}], "+", "yPivot"}]}], 
  "\[IndentingNewLine]"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"exponential", "[", 
    RowBox[{"x_", ",", "power_"}], "]"}], ":=", 
   RowBox[{"x", "/", 
    RowBox[{"(", 
     RowBox[{
      RowBox[{"(", 
       RowBox[{"1", "+", 
        RowBox[{"(", 
         RowBox[{"x", "^", "power"}], ")"}]}], ")"}], "^", 
      RowBox[{"(", 
       RowBox[{"1", "/", "power"}], ")"}]}], ")"}]}]}], 
  "\[IndentingNewLine]"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"calculateSigmoid", "[", 
     RowBox[{"x_", ",", "xPivot_", ",", "yPivot_"}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", "scaleValue", "}"}], ",", 
      RowBox[{
       RowBox[{"scaleValue", "=", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"x", "<", "xPivot"}], ",", 
          RowBox[{
           RowBox[{"-", "1"}], "*", 
           RowBox[{"equationScale", "[", 
            RowBox[{
             RowBox[{"1.0", "-", "xPivot"}], ",", 
             RowBox[{"1.0", "-", "yPivot"}], ",", "kPower", ",", "kSlope"}], 
            "]"}]}], ",", 
          RowBox[{"equationScale", "[", 
           RowBox[{"xPivot", ",", "yPivot", ",", "kPower", ",", "kSlope"}], 
           "]"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"exponentialCurve", "[", 
        RowBox[{
        "x", ",", "scaleValue", ",", "xPivot", ",", "yPivot", ",", "kPower", ",",
          "kSlope"}], "]"}]}]}], "]"}]}], ";"}], "\[IndentingNewLine]"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"agxCurve", "[", "x_", "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", "normalizedX", "}"}], ",", 
      RowBox[{
       RowBox[{"normalizedX", "=", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           RowBox[{"Log2", "[", 
            RowBox[{"x", "/", "kMidGray"}], "]"}], "-", "kNormLog2Min"}], 
          ")"}], "/", 
         RowBox[{"(", 
          RowBox[{"kNormLog2Max", "-", "kNormLog2Min"}], ")"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"calculateSigmoid", "[", 
         RowBox[{"normalizedX", ",", "kXPivot", ",", "kYPivot"}], "]"}], "^", 
        "kSlope"}]}]}], "]"}]}], ";"}], "\[IndentingNewLine]"}], "\n", 
 RowBox[{"Print", "[", "\"\<AgX tonemapping curve:\>\"", "]"}], "\n", 
 RowBox[{
  RowBox[{"Plot", "[", 
   RowBox[{
    RowBox[{"agxCurve", "[", "x", "]"}], ",", 
    RowBox[{"{", 
     RowBox[{"x", ",", "kLinearMin", ",", "kLinearMax"}], "}"}], ",", 
    RowBox[{"ScalingFunctions", "->", 
     RowBox[{"{", 
      RowBox[{"\"\<Log2\>\"", ",", "None"}], "}"}]}]}], "]"}], 
  "\[IndentingNewLine]"}], "\n", 
 RowBox[{"Print", "[", "\"\<Timothy Lottes' tonemapping equation:\>\"", 
  "]"}], "\n", 
 RowBox[{"Print", "[", "\"\<Generic soultion for b and c:\>\"", "]"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"tonemap", "[", 
    RowBox[{"x_", ",", "a_"}], "]"}], ":=", 
   RowBox[{
    RowBox[{"(", 
     RowBox[{"x", "^", "a"}], ")"}], "/", 
    RowBox[{"(", 
     RowBox[{
      RowBox[{"(", 
       RowBox[{"x", "^", "a"}], ")"}], "+", "c"}], ")"}]}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"Solve", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
      RowBox[{"tonemap", "[", 
       RowBox[{"midIn", ",", "a"}], "]"}], "==", "midOut"}], "}"}], ",", 
    RowBox[{"{", "c", "}"}]}], "]"}], "\[IndentingNewLine]"}], "\n", 
 RowBox[{"Print", 
  "[", "\"\<Soultion for b and c with hardcoded mid grey and max:\>\"", 
  "]"}], "\n", 
 RowBox[{
  RowBox[{"Solve", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
      RowBox[{"tonemap", "[", 
       RowBox[{"kMidGray", ",", "a"}], "]"}], "==", "kMidGray"}], "}"}], ",", 
    RowBox[{"{", "c", "}"}]}], "]"}], "\n"}], "\[IndentingNewLine]", 
 RowBox[{"Print", 
  "[", "\"\<NonlinearModelFit using solution for b and c from previous \
step.\>\"", "]"}], "\n", 
 RowBox[{"Print", 
  "[", "\"\<This uses log2 scale from the minimum AgX value to linear value \
of 2.0.\>\"", "]"}], "\n", 
 RowBox[{"Print", 
  "[", "\"\<This range was chosen because linear values below 2.0 are \
preceptually most important.\>\"", "]"}], "\n", 
 RowBox[{
  RowBox[{"data", "=", 
   RowBox[{"Table", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"x", ",", 
       RowBox[{"agxCurve", "[", "x", "]"}]}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"x", ",", 
       RowBox[{"2", "^", 
        RowBox[{"Range", "[", 
         RowBox[{
          RowBox[{"Log2", "[", "kLinearMin", "]"}], ",", 
          RowBox[{"Log2", "[", "kMidGray", "]"}], ",", "0.001"}], "]"}]}]}], 
      "}"}]}], "]"}]}], ";"}], "\n", 
 RowBox[{
  RowBox[{"nlm", "=", 
   RowBox[{"SetPrecision", "[", 
    RowBox[{
     RowBox[{"NonlinearModelFit", "[", 
      RowBox[{"data", ",", 
       RowBox[{
        RowBox[{"(", 
         RowBox[{"x", "^", "a"}], ")"}], "/", 
        RowBox[{"(", 
         RowBox[{
          RowBox[{"(", 
           RowBox[{"x", "^", "a"}], ")"}], "+", 
          RowBox[{"(", 
           RowBox[{"41", " ", 
            SuperscriptBox["9", 
             RowBox[{
              RowBox[{"-", "1"}], "+", "a"}]], " ", 
            SuperscriptBox["50", 
             RowBox[{"-", "a"}]]}], ")"}]}], ")"}]}], ",", 
       RowBox[{"{", "a", "}"}], ",", "x"}], "]"}], ",", "50"}], "]"}]}], 
  ";"}], "\n", 
 RowBox[{"nlmfResult", "=", 
  RowBox[{"Normal", "[", "nlm", "]"}]}], "\n", 
 RowBox[{
  RowBox[{"Plot", "[", 
   RowBox[{"nlmfResult", ",", 
    RowBox[{"{", 
     RowBox[{"x", ",", "kLinearMin", ",", "kLinearMax"}], "}"}], ",", 
    RowBox[{"ScalingFunctions", "->", 
     RowBox[{"{", 
      RowBox[{"\"\<Log2\>\"", ",", "None"}], "}"}]}]}], "]"}], 
  "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
     RowBox[{"Print", "[", "\"\<Slope calculations:\>\"", "]"}], " ", 
     RowBox[{"nlmfResultPrime", "[", "x_", "]"}]}], "=", 
    RowBox[{
     RowBox[{"D", "[", 
      RowBox[{
       RowBox[{"nlm", "[", "x", "]"}], ",", "x"}], "]"}], " ", 
     RowBox[{"Print", "[", "\"\<Slope at mid grey:\>\"", "]"}], " ", 
     RowBox[{"nlmfResultPrime", "[", "kMidGray", "]"}]}]}], "*)"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{"Print", "[", "\"\<Target slope at 0.18:\>\"", "]"}], "\n", 
 RowBox[{
  RowBox[{"N", "[", 
   RowBox[{
    RowBox[{"D", "[", 
     RowBox[{
      RowBox[{"agxCurve", "[", "x", "]"}], ",", "x"}], "]"}], "/.", 
    RowBox[{"x", "->", "kMidGray"}]}], "]"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{"Print", "[", "\"\<Slope of flitted curve configuration:\>\"", 
  "]"}], "\n", 
 RowBox[{
  RowBox[{"nlmPrime", "[", "x_", "]"}], "=", 
  RowBox[{"D", "[", 
   RowBox[{
    RowBox[{"nlm", "[", "x", "]"}], ",", "x"}], "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"nlmPrime", "[", "kMidGray", "]"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
     RowBox[{"Print", "[", "\"\<Keep slope:\>\"", "]"}], " ", 
     RowBox[{"finalCurve", "[", 
      RowBox[{"x_", ",", "d_"}], "]"}]}], "=", 
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{
       "x", "^", "1.3698996937805087981132601271383464336395263671875`50."}], 
       "/", 
       RowBox[{"(", 
        RowBox[{
        "0.3589386657045944682316775764039957011923057532031683162738200884827\
6492581737`48.0297400088891", "+", 
         RowBox[{
         "1.432526468047825052447853586826419519469270983317699675875250228567\
36494077976`48.190400530566855", " ", 
          RowBox[{
           RowBox[{"(", 
            RowBox[{
            "x", "^", 
             "1.3698996937805087981132601271383464336395263671875`50."}], 
            ")"}], "^", "d"}]}]}], ")"}]}], " ", 
      RowBox[{"Print", "[", "\"\<Slope calculations attempt 3:\>\"", "]"}], " ", 
      RowBox[{"finalCurvePrime", "[", "x_", "]"}]}], "=", 
     RowBox[{
      RowBox[{"D", "[", 
       RowBox[{
        RowBox[{"finalCurve", "[", 
         RowBox[{"x", ",", "d"}], "]"}], ",", "x"}], "]"}], " ", 
      RowBox[{"finalCurvePrime", "[", "kMidGray", "]"}], " ", 
      RowBox[{"Solve", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
          RowBox[{"finalCurvePrime", "[", "kMidGray", "]"}], "==", 
          "0.9697553989653070160481553207708290101528457763108801255222`47.\
64541945852553"}], "}"}], ",", 
        RowBox[{"{", "d", "}"}]}], "]"}]}]}]}], "*)"}], "\n"}], "\[IndentingNewLine]", 
 RowBox[{"Print", "[", "\"\<Various constants:\>\"", "]"}], "\n", 
 RowBox[{"Print", "[", "\"\<linear min:\>\"", "]"}], "\n", 
 RowBox[{"N", "[", 
  RowBox[{"kLinearMin", ",", "20"}], "]"}], "\n", 
 RowBox[{"Print", "[", "\"\<linear max:\>\"", "]"}], "\n", 
 RowBox[{"N", "[", 
  RowBox[{"kLinearMax", ",", "20"}], "]"}], "\n", 
 RowBox[{"Print", "[", "\"\<log2 min:\>\"", "]"}], "\n", 
 RowBox[{"N", "[", 
  RowBox[{"kLog2Min", ",", "20"}], "]"}], "\n", 
 RowBox[{"Print", "[", "\"\<log2 max:\>\"", "]"}], "\n", 
 RowBox[{
  RowBox[{"N", "[", 
   RowBox[{"kLog2Max", ",", "20"}], "]"}], "\[IndentingNewLine]"}], "\n", 
 RowBox[{"Print", "[", "\"\<agxCurve min:\>\"", "]"}], "\n", 
 RowBox[{"agxCurve", "[", "kLinearMin", "]"}], "\n", 
 RowBox[{"Print", "[", "\"\<agxCurve middle grey:\>\"", "]"}], "\n", 
 RowBox[{"N", "[", 
  RowBox[{"agxCurve", "[", "kMidGray", "]"}], "]"}], "\n", 
 RowBox[{"Print", "[", "\"\<agxCurve max:\>\"", "]"}], "\n", 
 RowBox[{"agxCurve", "[", "kLinearMax", "]"}]}], "Input",
 CellChangeTimes->{{3.953289950249071*^9, 3.953289950249071*^9}, {
  3.95329005800902*^9, 3.953290072382702*^9}, {3.9532903274827175`*^9, 
  3.95329039579179*^9}, {3.953290612346073*^9, 3.953290616368002*^9}, {
  3.95329067570607*^9, 3.9532906763394356`*^9}, {3.953290804892063*^9, 
  3.9532908646030006`*^9}, {3.95329093115374*^9, 3.9532909544999084`*^9}, {
  3.953291047031801*^9, 3.953291076296852*^9}, {3.953294947623211*^9, 
  3.9532949777100925`*^9}, {3.953295052457037*^9, 3.9532950955812244`*^9}},
 CellLabel->
  "In[759]:=",ExpressionUUID->"fade57e0-a462-4144-8e6d-c41313c69901"]
},
WindowSize->{1150.8, 1216.8},
WindowMargins->{{317.4, Automatic}, {-4.7999999999999545`, Automatic}},
FrontEndVersion->"14.2 for Microsoft Windows (64-bit) (December 26, 2024)",
StyleDefinitions->"Default.nb",
ExpressionUUID->"1314a039-1bd9-d745-a688-c53e779c8ee4"
]
(* End of Notebook Content *)

(* Internal cache information *)
(*CellTagsOutline
CellTagsIndex->{}
*)
(*CellTagsIndex
CellTagsIndex->{}
*)
(*NotebookFileOutline
Notebook[{
Cell[554, 20, 13881, 388, 1591, "Input",ExpressionUUID->"fade57e0-a462-4144-8e6d-c41313c69901"]
}
]
*)

